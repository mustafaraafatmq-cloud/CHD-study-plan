<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ASHRAE CHD Exam Study Schedule</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #1e3a8a;
            --secondary-color: #3b82f6;
            --complete-color: #10b981;
            --pending-color: #f59e0b;
            --current-color: #ef4444;
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f1f5f9;
        }
        .day-card {
            transition: all 0.3s ease;
            cursor: pointer;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -2px rgba(0,0,0,0.06);
            border-radius: 0.75rem;
        }
        .day-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -4px rgba(0,0,0,0.1);
        }
        .bg-primary-dark { background-color: var(--primary-color); }
        .border-rag-5 { border-color: var(--complete-color); background-color: #ecfdf5; }
        .border-rag-4 { border-color: var(--pending-color); background-color: #fffbeb; }
        .border-rag-3 { border-color: var(--secondary-color); background-color: #eff6ff; }
        .border-rag-1, .border-rag-2 { border-color: var(--current-color); background-color: #fef2f2; }
        .text-rag-5 { color: var(--complete-color); }
        .text-rag-4 { color: var(--pending-color); }
        .text-rag-3 { color: var(--secondary-color); }
        .text-rag-1, .text-rag-2 { color: var(--current-color); }
        .rag-1 { color: var(--current-color); }
        .rag-3 { color: var(--secondary-color); }
        .rag-5 { color: var(--complete-color); }
        .button-main {
            padding: 0.5rem 1rem;
            background-color: var(--secondary-color);
            color: white;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: background 0.2s;
            border: none;
        }
        .button-main:hover {
            background-color: var(--primary-color);
        }
        .button-save {
            padding: 0.5rem 1rem;
            background-color: var(--primary-color);
            color: white;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: background 0.2s;
            border: none;
        }
        .button-save:hover {
            background-color: #143173;
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <!-- Join/Create Screen -->
    <div id="join-container" class="max-w-lg mx-auto mt-20 p-8 bg-white rounded-xl shadow-lg">
        <h1 class="text-3xl font-extrabold text-primary-dark mb-4 text-center">Collaborative CHD Planner</h1>
        <p class="text-gray-600 mb-6 text-center">Join a friend's plan or create a new one to study together.</p>
        <div class="mb-4">
            <label for="plan-id-input" class="block text-sm font-medium text-gray-700 text-left">Join Existing Plan (Enter Plan ID):</label>
            <input type="text" id="plan-id-input" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-secondary-color focus:border-secondary-color" placeholder="e.g., chd-study-xxxx">
            <button id="join-plan-btn" class="button-main w-full mt-2">Join Plan</button>
        </div>
        <div class="my-4 text-gray-500 text-center">OR</div>
        <button id="create-plan-btn" class="button-main w-full bg-green-600 hover:bg-green-700">Create New Study Plan</button>
        <p id="join-error" class="text-red-600 mt-4 text-center hidden"></p>
        <div id="loading" class="text-gray-600 font-medium mt-4 text-center">Authenticating...</div>
    </div>

    <!-- Main App Container -->
    <div id="app-container" class="max-w-7xl mx-auto hidden">
        <header class="mb-8 p-6 bg-white rounded-xl shadow-lg">
            <h1 class="text-3xl font-extrabold text-primary-dark mb-1">ASHRAE CHD Exam Planner</h1>
            <p class="text-gray-500 mb-4">Study Schedule up to November 24, 2025</p>
            <div id="plan-id-display" class="mt-4 p-3 bg-gray-100 rounded-lg hidden">
                <p class="text-sm text-gray-700">Share this <strong>Plan ID</strong> with your study partner:</p>
                <div class="flex items-center justify-between mt-1">
                    <code id="plan-id-code" class="text-lg font-mono text-primary-dark p-2 bg-white rounded border"></code>
                    <button id="copy-plan-id-btn" class="button-main ml-4 px-3 py-2 text-xs">Copy ID</button>
                </div>
            </div>
            <div id="dashboard" class="grid grid-cols-1 sm:grid-cols-3 gap-4 mt-4">
                <div class="p-4 rounded-lg bg-secondary-color text-white shadow-md">
                    <p class="text-xs opacity-80">Days Remaining</p>
                    <p id="days-remaining" class="text-3xl font-bold">--</p>
                </div>
                <div class="p-4 rounded-lg bg-complete-color text-white shadow-md">
                    <p class="text-xs opacity-80">Days Completed</p>
                    <p id="days-completed" class="text-3xl font-bold">--</p>
                </div>
                <div class="p-4 rounded-lg bg-pending-color text-white shadow-md">
                    <p class="text-xs opacity-80">Overall Progress</p>
                    <p id="overall-progress" class="text-3xl font-bold">--</p>
                </div>
            </div>
        </header>
        <main class="p-6 bg-white rounded-xl shadow-lg">
            <h2 class="text-2xl font-bold text-gray-700 mb-6 border-b pb-2">Your Study Plan</h2>
            <div id="filter-controls" class="mb-6 space-y-4 md:space-y-0 md:flex md:justify-between md:items-center">
                <div class="flex space-x-2">
                    <button class="filter-btn button-main bg-gray-200 text-primary-dark active" data-filter="all">All Days</button>
                    <button class="filter-btn button-main bg-green-100 text-complete" data-filter="complete">Completed</button>
                    <button class="filter-btn button-main bg-yellow-100 text-pending" data-filter="pending">Pending</button>
                    <button class="filter-btn button-main bg-red-100 text-current" data-filter="review">Review Needed (RAG 1-2)</button>
                </div>
                <input id="search-input" type="text" placeholder="Search topics or notes..." class="p-2 border border-gray-300 rounded-md shadow-sm w-full md:w-1/3 focus:ring-secondary-color focus:border-secondary-color">
            </div>
            <div id="schedule-grid" class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-5 gap-4"></div>
            <div id="error-message" class="text-red-600 mt-4 hidden"></div>

            <!-- Insight Output Panel -->
            <div id="insight-panel" class="mt-8 pt-6 border-t border-gray-200 hidden">
                <h3 class="text-xl font-bold text-gray-700 mb-4 flex items-center">
                    <span class="mr-2 text-2xl text-green-600">‚ú®</span> Study Insight / Practice Questions
                </h3>
                <div id="insight-content" class="p-4 bg-gray-50 rounded-lg text-gray-700 shadow-inner min-h-24 flex items-center justify-center text-center">
                    Select a topic and click a feature button in the edit modal to load key information or practice questions here!
                </div>
                <div id="insight-sources" class="text-xs text-gray-500 mt-2 hidden"></div>
            </div>
        </main>
    </div>

    <!-- Modal for editing a Day Card -->
    <div id="edit-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white p-6 rounded-xl w-full max-w-md shadow-2xl transform transition-all">
            <h3 class="text-xl font-bold mb-4 text-primary-dark">Edit Study Day <span id="modal-date-display" class="font-light text-secondary-color"></span></h3>
            <label for="modal-topic-input" class="block text-sm font-medium text-gray-700">Topic Focus (Type or Select):</label>
            <input list="topic-options" id="modal-topic-input" type="text" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-secondary-color focus:border-secondary-color sm:text-sm rounded-md shadow-sm">
            <datalist id="topic-options"></datalist>
            <div class="mt-4">
                <label for="modal-status" class="block text-sm font-medium text-gray-700">Completion Status:</label>
                <select id="modal-status" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-secondary-color focus:border-secondary-color sm:text-sm rounded-md shadow-sm">
                    <option value="pending">Pending</option>
                    <option value="in_progress">In Progress</option>
                    <option value="complete">Complete</option>
                </select>
            </div>
            <div class="mt-4">
                <label for="modal-confidence" class="block text-sm font-medium text-gray-700">
                    Confidence Rating: <span id="confidence-value" class="font-bold text-secondary-color">3</span>
                    <span id="confidence-label" class="text-xs ml-2 text-secondary-color">(Average)</span>
                </label>
                <input type="range" id="modal-confidence" min="1" max="5" value="3" class="w-full mt-2 h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                <div class="flex justify-between text-xs text-gray-500 mt-1">
                    <span>1 (Low)</span>
                    <span>3 (Avg)</span>
                    <span>5 (Mastered)</span>
                </div>
            </div>
            <div class="mt-4">
                <label for="modal-notes" class="block text-sm font-medium text-gray-700">Study Notes:</label>
                <textarea id="modal-notes" rows="3" class="mt-1 block w-full pl-3 pr-3 py-2 text-base border-gray-300 focus:outline-none focus:ring-secondary-color focus:border-secondary-color sm:text-sm rounded-md shadow-sm"></textarea>
            </div>
            <div class="mt-6 space-y-3 md:space-y-0 md:flex md:justify-between md:items-center">
                <!-- AI Feature Buttons -->
                <div class="flex flex-col space-y-2 md:flex-row md:space-x-2 md:space-y-0">
                    <button id="get-insight-modal" class="button-main bg-green-600 hover:bg-green-700 flex items-center justify-center">
                        <span class="mr-1">üß†</span> Get AI Insight
                    </button>
                    <button id="get-questions-modal" class="button-main bg-blue-600 hover:bg-blue-700 flex items-center justify-center">
                        <span class="mr-1">‚ùì</span> Get 5 MCQs
                    </button>
                </div>
                <button id="save-modal" class="button-save">Save Changes</button>
                <button id="close-modal" class="button-main bg-gray-200 text-primary-dark">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Firebase Imports and Scripting -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // ------ YOUR FIREBASE CONFIG ------
        const firebaseConfig = {
            apiKey: "AIzaSyAWi2fE6rxQO2YwH3bayf7zB9NsEoPGXYM",
            authDomain: "chd-study-plan.firebaseapp.com",
            projectId: "chd-study-plan",
            storageBucket: "chd-study-plan.firebasestorage.app",
            messagingSenderId: "329855623463",
            appId: "1:329855623463:web:32be2774d68574ca910902"
        };

        // ---- ADD YOUR GEMINI API KEY HERE ----
        const GEMINI_API_KEY = "AIzaSyA5QdzNXzrzvjXEX-luvU7CXaXCLyCpaqM"; // <-- Paste your Gemini API key here

        let app, db, auth, userId = null;
        let currentPlanId = null;
        let scheduleData = [];
        let editingIndex = -1;
        let currentFilter = 'all';
        let currentSearchTerm = '';
        let currentInsightTopic = '';
        const EXAM_DATE = '2025-11-24';
        const START_DATE = '2025-11-05';

        const CORE_TOPICS = [
            'HVAC Fundamentals & Terminology',
            'Psychrometrics & Air Conditioning Processes',
            'Heating/Cooling Load Calculations',
            'HVAC System Types & Components (VAV, VRF, Chillers)',
            'Air Distribution & Duct Design',
            'Hydronic Systems & Pump Selection',
            'Controls & Building Automation',
            'Codes, Standards, and Ethics (90.1, 62.1)',
            'Practice Exams & Final Review'
        ];

        // AI API Config
        const API_URL_INSIGHT = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${GEMINI_API_KEY}`;
        const API_URL_MCQ = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${GEMINI_API_KEY}`;
        const BASE_DELAY = 1000;
        const MAX_RETRIES = 4;

        function formatDate(dateStr) {
            const date = new Date(dateStr + 'T00:00:00');
            return date.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
        }
        function getDayDifference(dateStr1, dateStr2) {
            const oneDay = 1000 * 60 * 60 * 24;
            const date1 = new Date(dateStr1 + 'T00:00:00');
            const date2 = new Date(dateStr2 + 'T00:00:00');
            return Math.round((date2.getTime() - date1.getTime()) / oneDay);
        }
        function generateInitialSchedule() {
            const schedule = [];
            let currentDate = new Date(START_DATE + 'T00:00:00');
            const examDate = new Date(EXAM_DATE + 'T00:00:00');
            const topicCycle = CORE_TOPICS.filter(t => !t.includes('Review') && !t.includes('Practice'));
            let topicIndex = 0;
            while (currentDate <= examDate) {
                const dateStr = currentDate.toISOString().substring(0, 10);
                let defaultTopic = 'Rest/Buffer Day';
                if (dateStr === EXAM_DATE) {
                    defaultTopic = 'ASHRAE CHD Exam Day!';
                } else if (getDayDifference(dateStr, EXAM_DATE) > 2) {
                    defaultTopic = topicCycle[topicIndex % topicCycle.length];
                    topicIndex++;
                } else if (getDayDifference(dateStr, EXAM_DATE) === 2) {
                    defaultTopic = CORE_TOPICS.find(t => t.includes('Practice Exams'));
                } else if (getDayDifference(dateStr, EXAM_DATE) === 1) {
                    defaultTopic = CORE_TOPICS.find(t => t.includes('Final Review'));
                }
                schedule.push({
                    date: dateStr,
                    topic: defaultTopic,
                    status: dateStr === EXAM_DATE ? 'exam' : 'pending',
                    notes: '',
                    confidence: 3
                });
                currentDate.setDate(currentDate.getDate() + 1);
            }
            return schedule;
        }
        async function setupFirebase() {
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                setLogLevel('debug');
                await new Promise((resolve) => {
                    const unsubscribe = onAuthStateChanged(auth, async (user) => {
                        if (user) {
                            userId = user.uid;
                        } else {
                            await signInAnonymously(auth);
                            userId = auth.currentUser.uid;
                        }
                        unsubscribe();
                        resolve();
                    });
                });
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('join-container').classList.remove('hidden');
            } catch (error) {
                console.error("Firebase Setup or Auth Error:", error);
                document.getElementById('loading').textContent = `Authentication failed. Cannot connect to database. Error: ${error.message}`;
            }
        }
        function loadPlanUI(planId) {
            currentPlanId = planId;
            document.getElementById('join-container').classList.add('hidden');
            document.getElementById('app-container').classList.remove('hidden');
            document.getElementById('plan-id-code').textContent = planId;
            document.getElementById('plan-id-display').classList.remove('hidden');
            listenForScheduleChanges(planId);
        }
        async function createNewPlan() {
            const planId = 'chd-study-' + Math.random().toString(36).substring(2, 8);
            currentPlanId = planId;
            scheduleData = generateInitialSchedule();
            await saveSchedule();
            loadPlanUI(planId);
        }
        async function joinPlan() {
            const planId = document.getElementById('plan-id-input').value.trim();
            const errorEl = document.getElementById('join-error');
            if (!planId) {
                errorEl.textContent = 'Please enter a Plan ID.';
                errorEl.classList.remove('hidden');
                return;
            }
            const scheduleRef = doc(db, "plans", planId);
            try {
                const docSnap = await getDoc(scheduleRef);
                if (docSnap.exists()) {
                    errorEl.classList.add('hidden');
                    loadPlanUI(planId);
                } else {
                    errorEl.textContent = 'Plan ID not found. Please check the ID or create a new plan.';
                    errorEl.classList.remove('hidden');
                }
            } catch (error) {
                console.error("Error checking plan:", error);
                errorEl.textContent = `Error: ${error.message}`;
                errorEl.classList.remove('hidden');
            }
        }
        function listenForScheduleChanges(planId) {
            const scheduleRef = doc(db, "plans", planId);
            onSnapshot(scheduleRef, (docSnap) => {
                if (docSnap.exists()) {
                    scheduleData = docSnap.data().schedule.map(day => ({
                        notes: '',
                        confidence: 3,
                        ...day
                    }));
                    console.log("Schedule loaded from Firestore.");
                } else {
                    console.log("Creating new schedule data for this plan.");
                    scheduleData = generateInitialSchedule();
                    saveSchedule();
                }
                renderSchedule(currentFilter, currentSearchTerm);
                updateDashboard();
            }, (error) => {
                console.error("Firestore Listen Error:", error);
                document.getElementById('error-message').textContent = "Error loading schedule: " + error.message;
                document.getElementById('error-message').classList.remove('hidden');
            });
        }
        async function saveSchedule() {
            if (!db || !currentPlanId) return;
            const scheduleRef = doc(db, "plans", currentPlanId);
            try {
                await setDoc(scheduleRef, { schedule: scheduleData, lastUpdated: new Date() }, { merge: false });
                console.log("Schedule saved successfully to public plan.");
            } catch (error) {
                console.error("Error saving schedule:", error);
                document.getElementById('error-message').textContent = "Error saving schedule: " + error.message;
                document.getElementById('error-message').classList.remove('hidden');
            }
        }

        // ------ Gemini AI Functions ------
        async function fetchGemini(prompt, type="insight") {
            const url = (type === "mcq") ? API_URL_MCQ : API_URL_INSIGHT;
            if (!GEMINI_API_KEY || GEMINI_API_KEY.trim() === "") {
                displayInsight("Please add your Gemini API key in the script.", []);
                return null;
            }
            const payload = {
                contents: [{ parts: [{ text: prompt }] }]
            };
            for (let tries=0; tries<=MAX_RETRIES; tries++) {
                try {
                    const response = await fetch(url, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify(payload)
                    });
                    if (response.status === 429 && tries < MAX_RETRIES) {
                        await new Promise(r => setTimeout(r, BASE_DELAY * Math.pow(2, tries)));
                        continue;
                    }
                    if (!response.ok) throw new Error(`Failed with status ${response.status}`);
                    const result = await response.json();
                    return result;
                } catch (e) {
                    if (tries === MAX_RETRIES) throw e;
                }
            }
        }

        async function getAIInsight(topic) {
            document.getElementById('insight-panel').classList.remove('hidden');
            const prompt = `Explain concisely (max 150 words) the key concepts, formulas, and study tips for ASHRAE CHD exam topic "${topic}". Focus on ASHRAE standards, especially 90.1 and 62.1.`;
            displayInsight("Loading Gemini study insight ...", [], true);
            try {
                const result = await fetchGemini(prompt, "insight");
                const candidate = result?.candidates?.[0]?.content?.parts?.[0]?.text;
                if (candidate) displayInsight(candidate, []);
                else displayInsight("No insight returned.", []);
            } catch(e) {
                displayInsight("AI Insight could not be generated: " + e.message, []);
            }
        }

        async function getAIMCQs(topic) {
            document.getElementById('insight-panel').classList.remove('hidden');
            const prompt = `Generate 5 multiple-choice practice questions (with answers hidden and revealed only by clicking) for the ASHRAE CHD exam topic "${topic}". Each question must use ASHRAE standards and be exam relevant. Respond strictly in a JSON array of objects: [{"question": "...", "options": ["..."], "answer": "..."}]`;
            displayInsight("Loading Gemini MCQ questions ...", [], true);
            try {
                const result = await fetchGemini(prompt, "mcq");
                let jsonText = result?.candidates?.[0]?.content?.parts?.[0]?.text;
                if (!jsonText) throw new Error("No MCQs returned.");
                if (!jsonText.startsWith("[")) jsonText = jsonText.substring(jsonText.indexOf("["));
                const questions = JSON.parse(jsonText);
                displayQuestions(questions, topic);
            } catch (e) {
                displayInsight("AI MCQs could not be generated: " + e.message, []);
            }
        }

        function displayInsight(text, sources, isLoading = false) {
            const panel = document.getElementById('insight-panel');
            const contentDiv = document.getElementById('insight-content');
            const sourcesDiv = document.getElementById('insight-sources');
            panel.classList.remove('hidden');
            if (isLoading) {
                contentDiv.innerHTML = `<span class='text-gray-500'>${text}</span>`;
                sourcesDiv.classList.add('hidden');
                return;
            }
            // Markup for bolds and formulas
            let formatted = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            formatted = formatted.replace(/\$(.*?)\$/g, '<span class="text-secondary-color italic font-mono">$1</span>');
            contentDiv.innerHTML = formatted;
            sourcesDiv.textContent = "";
            if (sources?.length) {
                sourcesDiv.classList.remove('hidden');
                sourcesDiv.innerHTML = sources.map(s=>`<a href="${s.uri}" target="_blank">${s.title}</a>`).join(" | ");
            } else {
                sourcesDiv.classList.add('hidden');
            }
        }

        function displayQuestions(questions, topic) {
            const panel = document.getElementById('insight-panel');
            panel.classList.remove('hidden');
            const contentDiv = document.getElementById('insight-content');
            let html = `<h4 class="text-lg font-bold text-gray-800 mb-2">Practice MCQs: ${topic}</h4>`;
            html += questions.map((q, i)=>{
                const opts = q.options.map(opt=>`<li class="p-2 border border-gray-200 rounded-md mb-1 bg-gray-50">${opt}</li>`).join("");
                return `<div class="mb-4 p-4 border border-blue-200 bg-blue-50 rounded-lg shadow-sm">
                            <p class="font-semibold text-primary-dark">Q${i+1}: ${q.question}</p>
                            <ul class="space-y-1 text-gray-800">${opts}</ul>
                            <button class="show-answer-btn button-main mt-2 px-3 py-1 text-xs" data-answer="${q.answer.replace(/"/g, '&quot;')}">Show Answer</button>
                            <p class="answer-text mt-2 p-2 bg-white border border-blue-300 rounded hidden italic text-sm font-semibold text-green-700"></p>
                        </div>`;
            }).join("");
            contentDiv.innerHTML = html;
            Array.from(contentDiv.getElementsByClassName('show-answer-btn')).forEach(btn=>{
                btn.onclick = function(e){
                    const answerBox = e.target.parentNode.querySelector('.answer-text');
                    answerBox.textContent = 'Answer: ' + e.target.dataset.answer;
                    answerBox.classList.remove('hidden');
                    e.target.classList.add('hidden');
                };
            });
        }

        function filterSchedule(filter, searchTerm) {
            const term = searchTerm.toLowerCase().trim();
            return scheduleData.filter(day => {
                const matchesSearch = term === '' ||
                                      day.topic.toLowerCase().includes(term) ||
                                      (day.notes && day.notes.toLowerCase().includes(term));
                if (!matchesSearch) return false;
                switch (filter) {
                    case 'all':
                        return true;
                    case 'complete':
                        return day.status === 'complete';
                    case 'pending':
                        return day.status !== 'complete' && day.status !== 'exam';
                    case 'review':
                        return day.confidence < 3 && day.status !== 'complete' && day.status !== 'exam';
                    default:
                        return true;
                }
            });
        }
        function renderSchedule(filter = 'all', searchTerm = '') {
            currentFilter = filter;
            currentSearchTerm = searchTerm;
            const filteredSchedule = filterSchedule(filter, searchTerm);
            const grid = document.getElementById('schedule-grid');
            grid.innerHTML = '';
            const todayStr = new Date().toISOString().substring(0, 10);
            filteredSchedule.forEach((day, index) => {
                let statusText = 'Planned';
                let confidenceIndicator = '';
                let cardClass = 'bg-gray-100 border-gray-300';
                let textClass = 'text-gray-600';
                const rag = day.confidence;
                if (rag <= 2) {
                    cardClass = 'border-rag-1';
                    confidenceIndicator = '‚ùó Low Conf.';
                } else if (rag === 3) {
                    cardClass = 'border-rag-3';
                    confidenceIndicator = '‚öôÔ∏è Average';
                } else if (rag === 4) {
                    cardClass = 'border-rag-4';
                    confidenceIndicator = 'üëç Good';
                } else if (rag === 5) {
                    cardClass = 'border-rag-5';
                    confidenceIndicator = '‚úÖ Mastered';
                }
                if (day.status === 'complete') {
                    cardClass = 'border-rag-5 bg-complete-light';
                    textClass = 'text-complete';
                    statusText = 'Completed!';
                    confidenceIndicator = '&#x2714; Complete';
                } else if (day.status === 'in_progress') {
                    statusText = 'In Progress';
                    textClass = `text-rag-${rag}`;
                } else if (day.status === 'pending') {
                    statusText = 'Pending';
                    textClass = `text-rag-${rag}`;
                } else if (day.status === 'exam') {
                    cardClass = 'bg-primary-dark border-primary-dark text-white';
                    textClass = 'text-white';
                    statusText = 'EXAM DAY';
                    confidenceIndicator = 'GOOD LUCK!';
                }
                if (day.date === todayStr && day.status !== 'exam') {
                    cardClass += ' border-4 border-dashed border-current';
                    statusText = (day.status === 'complete' ? 'COMPLETED TODAY' : 'CURRENT FOCUS');
                }
                let noteIndicator = day.notes && day.notes.trim() !== ''
                    ? '<span class="ml-2 text-xs text-secondary-color">&#x1F4DD;</span>' : '';
                const cardHtml = `
                    <div id="day-${index}" data-index="${index}"
                         class="day-card p-4 border-l-4 ${cardClass} text-gray-800 flex flex-col justify-between"
                         ${day.status !== 'exam' ? `onclick="openModal(${scheduleData.findIndex(d => d.date === day.date)})"` : ''}>
                        <div>
                            <p class="text-xs font-semibold uppercase text-gray-500 mb-1">${formatDate(day.date)}</p>
                            <p class="text-lg font-bold truncate ${day.status === 'exam' ? 'text-white' : ''}">${day.topic}${noteIndicator}</p>
                        </div>
                        <div class="mt-2 pt-2 border-t border-gray-200 flex justify-between items-center">
                            <span class="text-sm font-medium ${textClass}">
                                ${statusText}
                            </span>
                            <span class="text-xs font-semibold ${day.status === 'exam' ? 'text-white' : textClass}">
                                ${confidenceIndicator}
                            </span>
                        </div>
                    </div>
                `;
                grid.innerHTML += cardHtml;
            });
        }
        function updateDashboard() {
            const todayStr = new Date().toISOString().substring(0, 10);
            const daysRemaining = Math.max(0, getDayDifference(todayStr, EXAM_DATE));
            const daysCompleted = scheduleData.filter(day => day.status === 'complete').length;
            const studyDays = scheduleData.filter(day => day.date !== EXAM_DATE).length;
            const progress = studyDays > 0 ? Math.round((daysCompleted / studyDays) * 100) : 0;
            document.getElementById('days-remaining').textContent = daysRemaining;
            document.getElementById('days-completed').textContent = daysCompleted;
            document.getElementById('overall-progress').textContent = `${progress}%`;
        }

        // ------- Modal Logic -------
        function updateConfidenceDisplay(value) {
            const display = document.getElementById('confidence-value');
            const label = document.getElementById('confidence-label');
            display.textContent = value;
            let text = '';
            let colorClass = '';
            if (value <= 2) {
                text = '(Needs Review)'; colorClass = 'rag-1';
            } else if (value == 3) {
                text = '(Average)'; colorClass = 'rag-3';
            } else if (value == 4) {
                text = '(Good)'; colorClass = 'rag-4';
            } else {
                text = '(Mastered)'; colorClass = 'rag-5';
            }
            label.textContent = text;
            display.className = `font-bold ${colorClass}`;
            label.className = `text-xs ml-2 ${colorClass}`;
        }
        window.openModal = function(index) {
            editingIndex = index;
            const day = scheduleData[index];
            if (day.status === 'exam') return;
            const modal = document.getElementById('edit-modal');
            document.getElementById('modal-date-display').textContent = formatDate(day.date);
            const topicInput = document.getElementById('modal-topic-input');
            const topicDatalist = document.getElementById('topic-options');
            const notesTextarea = document.getElementById('modal-notes');
            const confidenceSlider = document.getElementById('modal-confidence');
            topicDatalist.innerHTML = '';
            CORE_TOPICS.forEach(topic => {
                const option = document.createElement('option');
                option.value = topic;
                topicDatalist.appendChild(option);
            });
            topicInput.value = day.topic;
            document.getElementById('modal-status').value = day.status;
            notesTextarea.value = day.notes || '';
            confidenceSlider.value = day.confidence || 3;
            updateConfidenceDisplay(confidenceSlider.value);
            confidenceSlider.oninput = (e) => updateConfidenceDisplay(e.target.value);

            // Modal buttons:
            document.getElementById('get-insight-modal').onclick = () => {
                getAIInsight(topicInput.value);
            };
            document.getElementById('get-questions-modal').onclick = () => {
                getAIMCQs(topicInput.value);
            };
            modal.classList.remove('hidden');
        }
        function closeModal() {
            document.getElementById('edit-modal').classList.add('hidden');
            editingIndex = -1;
        }
        document.getElementById('close-modal').onclick = closeModal;

        document.getElementById('save-modal').onclick = async function() {
            if (editingIndex === -1) return;
            const topic = document.getElementById('modal-topic-input').value;
            const status = document.getElementById('modal-status').value;
            const notes = document.getElementById('modal-notes').value;
            const confidence = parseInt(document.getElementById('modal-confidence').value, 10);
            scheduleData[editingIndex].topic = topic;
            scheduleData[editingIndex].status = status;
            scheduleData[editingIndex].notes = notes;
            scheduleData[editingIndex].confidence = confidence;
            closeModal();
            await saveSchedule();

            // Success feedback animation for save
            const saveBtn = document.getElementById('save-modal');
            saveBtn.textContent = "Saved!";
            setTimeout(() => { saveBtn.textContent = "Save Changes"; }, 1100);
        }

        document.querySelectorAll('#filter-controls button').forEach(button => {
            button.addEventListener('click', (e) => {
                document.querySelectorAll('#filter-controls button').forEach(btn => btn.classList.remove('active', 'bg-primary-dark', 'text-white', 'shadow-lg'));
                e.currentTarget.classList.add('active', 'bg-primary-dark', 'text-white', 'shadow-lg');
                renderSchedule(e.currentTarget.dataset.filter, currentSearchTerm);
            });
        });
        document.getElementById('search-input').addEventListener('input', (e) => {
            renderSchedule(currentFilter, e.target.value);
        });
        document.getElementById('join-plan-btn').onclick = joinPlan;
        document.getElementById('create-plan-btn').onclick = createNewPlan;
        document.getElementById('copy-plan-id-btn').onclick = (e) => {
            const btn = e.currentTarget;
            const planId = document.getElementById('plan-id-code').textContent;
            const tempInput = document.createElement('textarea');
            tempInput.value = planId;
            document.body.appendChild(tempInput);
            tempInput.select();
            try {
                document.execCommand('copy');
                btn.textContent = 'Copied!';
                setTimeout(() => { btn.textContent = 'Copy ID'; }, 2000);
            } catch (err) {
                console.error('Failed to copy text: ', err);
                btn.textContent = 'Error';
                setTimeout(() => { btn.textContent = 'Copy ID'; }, 2000);
            }
            document.body.removeChild(tempInput);
        };
        window.onload = function() {
            document.querySelector('#filter-controls button[data-filter="all"]').classList.add('active', 'bg-primary-dark', 'text-white', 'shadow-lg');
            setupFirebase();
        };
    </script>
</body>
</html>
