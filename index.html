<!-- /index.html -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ASHRAE CHD Exam Study Schedule</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">
  <style>
    :root{
      --primary-color:#1e3a8a;
      --secondary-color:#3b82f6;
      --complete-color:#10b981;
      --pending-color:#f59e0b;
      --current-color:#ef4444;
    }
    body{font-family:'Inter',sans-serif;background:#f1f5f9}

    /* Missing utility classes fixed */
    .bg-primary-dark{background-color:var(--primary-color)}
    .bg-secondary-color{background-color:var(--secondary-color)}
    .bg-complete-color{background-color:var(--complete-color)}
    .bg-pending-color{background-color:var(--pending-color)}
    .text-complete{color:var(--complete-color)}
    .text-pending{color:var(--pending-color)}
    .text-current{color:var(--current-color)}

    .border-rag-5{border-color:var(--complete-color);background:#ecfdf5}
    .border-rag-4{border-color:var(--pending-color);background:#fffbeb}
    .border-rag-3{border-color:var(--secondary-color);background:#eff6ff}
    .border-rag-1,.border-rag-2{border-color:var(--current-color);background:#fef2f2}

    .text-rag-5{color:var(--complete-color)}
    .text-rag-4{color:var(--pending-color)}
    .text-rag-3{color:var(--secondary-color)}
    .text-rag-1,.text-rag-2{color:var(--current-color)}
    .rag-1{color:var(--current-color)}
    .rag-3{color:var(--secondary-color)}
    .rag-4{color:var(--pending-color)}
    .rag-5{color:var(--complete-color)}

    .day-card{transition:all .2s ease;cursor:pointer;box-shadow:0 4px 6px -1px rgba(0,0,0,.1),0 2px 4px -2px rgba(0,0,0,.06);border-radius:.75rem}
    .day-card:hover{transform:translateY(-2px);box-shadow:0 10px 15px -3px rgba(0,0,0,.1),0 4px 6px -4px rgba(0,0,0,.1)}

    .button-main{padding:.5rem 1rem;background:var(--secondary-color);color:#fff;border-radius:.5rem;font-weight:600;border:none}
    .button-main:hover{background:var(--primary-color)}
    .button-save{padding:.5rem 1rem;background:var(--primary-color);color:#fff;border-radius:.5rem;font-weight:600;border:none}
    .button-save:hover{background:#143173}

    /* Modal focus-trap hint */
    .modal-open{overflow:hidden}

    /* Simple toast */
    #toast{position:fixed;bottom:16px;right:16px;z-index:9999;display:none}
    #toast.show{display:block}
  </style>
</head>
<body class="p-4 md:p-8">
  <!-- Toast -->
  <div id="toast" class="rounded-lg bg-black/80 text-white px-4 py-2 text-sm shadow"></div>

  <!-- Join/Create -->
  <div id="join-container" class="max-w-lg mx-auto mt-20 p-8 bg-white rounded-xl shadow-lg hidden">
    <h1 class="text-3xl font-extrabold text-primary-dark mb-4 text-center">Collaborative CHD Planner</h1>
    <p class="text-gray-600 mb-6 text-center">Join a friend's plan or create a new one to study together.</p>

    <div class="mb-4">
      <label for="plan-id-input" class="block text-sm font-medium text-gray-700">Join Existing Plan (Plan ID)</label>
      <input id="plan-id-input" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm" placeholder="e.g., chd-study-xxxx" inputmode="search" autocomplete="off">
      <button id="join-plan-btn" class="button-main w-full mt-2">Join Plan</button>
    </div>

    <div class="my-4 text-gray-500 text-center">OR</div>
    <button id="create-plan-btn" class="button-main w-full bg-green-600 hover:bg-green-700">Create New Study Plan</button>

    <p id="join-error" class="text-red-600 mt-4 text-center hidden"></p>
    <div id="loading" class="text-gray-600 font-medium mt-4 text-center">Initializing...</div>
  </div>

  <!-- App -->
  <div id="app-container" class="max-w-7xl mx-auto hidden" aria-live="polite">
    <header class="mb-8 p-6 bg-white rounded-xl shadow-lg">
      <h1 class="text-3xl font-extrabold text-primary-dark mb-1">ASHRAE CHD Exam Planner</h1>
      <p class="text-gray-500 mb-4">Study Schedule up to November 24, 2025</p>
      <div id="plan-id-display" class="mt-4 p-3 bg-gray-100 rounded-lg hidden">
        <p class="text-sm text-gray-700">Share this <strong>Plan ID</strong> with your study partner:</p>
        <div class="flex items-center justify-between mt-1">
          <code id="plan-id-code" class="text-lg font-mono text-primary-dark p-2 bg-white rounded border"></code>
          <button id="copy-plan-id-btn" class="button-main ml-4 px-3 py-2 text-xs">Copy ID</button>
        </div>
      </div>

      <div id="dashboard" class="grid grid-cols-1 sm:grid-cols-3 gap-4 mt-4">
        <div class="p-4 rounded-lg bg-secondary-color text-white shadow-md">
          <p class="text-xs opacity-80">Days Remaining</p>
          <p id="days-remaining" class="text-3xl font-bold">--</p>
        </div>
        <div class="p-4 rounded-lg bg-complete-color text-white shadow-md">
          <p class="text-xs opacity-80">Days Completed</p>
          <p id="days-completed" class="text-3xl font-bold">--</p>
        </div>
        <div class="p-4 rounded-lg bg-pending-color text-white shadow-md">
          <p class="text-xs opacity-80">Overall Progress</p>
          <p id="overall-progress" class="text-3xl font-bold">--</p>
        </div>
      </div>
    </header>

    <main class="p-6 bg-white rounded-xl shadow-lg">
      <h2 class="text-2xl font-bold text-gray-700 mb-6 border-b pb-2">Your Study Plan</h2>

      <div id="filter-controls" class="mb-6 space-y-3 md:space-y-0 md:flex md:justify-between md:items-center">
        <div class="flex flex-wrap gap-2">
          <button class="filter-btn button-main bg-gray-200 text-primary-dark" data-filter="all">All Days</button>
          <button class="filter-btn button-main bg-green-100 text-complete" data-filter="complete">Completed</button>
          <button class="filter-btn button-main bg-yellow-100 text-pending" data-filter="pending">Pending</button>
          <button class="filter-btn button-main bg-red-100 text-current" data-filter="review">Review Needed (RAG 1-2)</button>
        </div>
        <input id="search-input" type="text" placeholder="Search topics or notes..." class="p-2 border border-gray-300 rounded-md shadow-sm w-full md:w-1/3">
      </div>

      <div id="schedule-grid" class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-5 gap-4" role="list"></div>
      <div id="error-message" class="text-red-600 mt-4 hidden"></div>

      <!-- Insight Panel -->
      <div id="insight-panel" class="mt-8 pt-6 border-t border-gray-200 hidden">
        <h3 class="text-xl font-bold text-gray-700 mb-4 flex items-center">
          <span class="mr-2 text-2xl text-green-600">‚ú®</span> Study Insight / Practice Questions
        </h3>
        <div id="insight-content" class="p-4 bg-gray-50 rounded-lg text-gray-700 shadow-inner min-h-24 text-sm"></div>
        <div id="insight-sources" class="text-xs text-gray-500 mt-2 hidden"></div>
      </div>
    </main>
  </div>

  <!-- Edit Modal -->
  <div id="edit-modal" class="fixed inset-0 bg-gray-900/75 flex items-center justify-center p-4 z-50 hidden" role="dialog" aria-modal="true" aria-labelledby="modal-title">
    <div class="bg-white p-6 rounded-xl w-full max-w-md shadow-2xl">
      <h3 id="modal-title" class="text-xl font-bold mb-4 text-primary-dark">Edit Study Day <span id="modal-date-display" class="font-light text-secondary-color"></span></h3>
      <label for="modal-topic-input" class="block text-sm font-medium text-gray-700">Topic Focus (Type or Select):</label>
      <input list="topic-options" id="modal-topic-input" type="text" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 rounded-md shadow-sm">
      <datalist id="topic-options"></datalist>

      <div class="mt-4">
        <label for="modal-status" class="block text-sm font-medium text-gray-700">Completion Status:</label>
        <select id="modal-status" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 rounded-md shadow-sm">
          <option value="pending">Pending</option>
          <option value="in_progress">In Progress</option>
          <option value="complete">Complete</option>
        </select>
      </div>

      <div class="mt-4">
        <label for="modal-confidence" class="block text-sm font-medium text-gray-700">
          Confidence Rating: <span id="confidence-value" class="font-bold text-secondary-color">3</span>
          <span id="confidence-label" class="text-xs ml-2 text-secondary-color">(Average)</span>
        </label>
        <input type="range" id="modal-confidence" min="1" max="5" value="3" class="w-full mt-2 h-2 bg-gray-200 rounded-lg">
        <div class="flex justify-between text-xs text-gray-500 mt-1">
          <span>1 (Low)</span><span>3 (Avg)</span><span>5 (Mastered)</span>
        </div>
      </div>

      <div class="mt-4">
        <label for="modal-notes" class="block text-sm font-medium text-gray-700">Study Notes:</label>
        <textarea id="modal-notes" rows="3" class="mt-1 block w-full pl-3 pr-3 py-2 text-base border-gray-300 rounded-md shadow-sm" maxlength="2000"></textarea>
      </div>

      <div class="mt-6 flex flex-wrap gap-2">
        <button id="get-insight-modal" class="button-main bg-green-600 hover:bg-green-700 flex items-center justify-center"><span class="mr-1">üß†</span> Get AI Insight</button>
        <button id="get-questions-modal" class="button-main bg-blue-600 hover:bg-blue-700 flex items-center justify-center"><span class="mr-1">‚ùì</span> Get 5 MCQs</button>
        <div class="flex-1"></div>
        <button id="save-modal" class="button-save">Save</button>
        <button id="close-modal" class="button-main bg-gray-200 text-primary-dark">Cancel</button>
      </div>
    </div>
  </div>

  <!-- App Script -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, onSnapshot, getDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    /* --------- CONFIG (keep secrets server-side) --------- */
    const firebaseConfig = {
      apiKey: "YOUR_PUBLIC_FIREBASE_API_KEY",
      authDomain: "chd-study-plan.firebaseapp.com",
      projectId: "chd-study-plan",
      storageBucket: "chd-study-plan.firebasestorage.app",
      messagingSenderId: "329855623463",
      appId: "1:329855623463:web:32be2774d68574ca910902"
    };

    // Serverless proxy endpoints (Cloud Function / Next.js API / Firebase HTTPS Function)
    const API_URL_INSIGHT = "/api/gemini/insight";
    const API_URL_MCQ = "/api/gemini/mcq";

    /* ------------------ CONSTANTS ------------------ */
    const TZ = "Asia/Kuwait";
    const EXAM_DATE = "2025-11-24";
    const START_DATE = "2025-11-05";
    const CORE_TOPICS = Object.freeze([
      "HVAC Fundamentals & Terminology",
      "Psychrometrics & Air Conditioning Processes",
      "Heating/Cooling Load Calculations",
      "HVAC System Types & Components (VAV, VRF, Chillers)",
      "Air Distribution & Duct Design",
      "Hydronic Systems & Pump Selection",
      "Controls & Building Automation",
      "Codes, Standards, and Ethics (90.1, 62.1)",
      "Practice Exams & Final Review"
    ]);

    /* ------------------ STATE ------------------ */
    const appState = {
      app: null, db: null, auth: null, userId: null,
      planId: null, schedule: [], editingIndex: -1,
      currentFilter: "all", currentSearch: "", unsub: null
    };

    /* ------------------ UTILS ------------------ */
    const $ = (sel)=>document.querySelector(sel);
    const el = (id)=>document.getElementById(id);

    function toast(msg, ms=1800){ const t=el("toast"); t.textContent=msg; t.classList.add("show"); setTimeout(()=>t.classList.remove("show"), ms); }

    const clamp=(n,min,max)=>Math.max(min,Math.min(max,n));

    function todayISO(tz=TZ){
      const now = new Date();
      // why: ensure date is computed in target timezone, avoiding off-by-one
      const parts = new Intl.DateTimeFormat('en-CA',{timeZone:tz,year:'numeric',month:'2-digit',day:'2-digit'}).formatToParts(now);
      const y=parts.find(p=>p.type==='year').value;
      const m=parts.find(p=>p.type==='month').value;
      const d=parts.find(p=>p.type==='day').value;
      return `${y}-${m}-${d}`;
    }
    function formatDateISO(iso, tz=TZ){
      const d = new Date(`${iso}T00:00:00`);
      return d.toLocaleDateString('en-US',{timeZone:tz,weekday:'short',month:'short',day:'numeric'});
    }
    function dayDiff(aISO,bISO){
      const a=new Date(`${aISO}T00:00:00`), b=new Date(`${bISO}T00:00:00`);
      return Math.round((b-a)/(1000*60*60*24));
    }
    function debounce(fn,ms){ let t; return (...args)=>{ clearTimeout(t); t=setTimeout(()=>fn(...args),ms); }; }
    function throttle(fn,ms){ let last=0; return (...args)=>{ const now=Date.now(); if(now-last>=ms){ last=now; fn(...args);} }; }

    function sanitizeHtml(s){
      // why: prevent XSS from model responses; allow only safe inline tags
      const div=document.createElement('div'); div.textContent=s; return div.innerHTML;
    }

    function validatePlanId(id){ return /^chd-study-[a-z0-9]{4,10}$/i.test(id); }

    /* --------------- SCHEDULE LOGIC --------------- */
    function generateInitialSchedule(startISO=START_DATE, examISO=EXAM_DATE){
      const schedule=[]; const topicPool=CORE_TOPICS.filter(t=>!/Review|Practice/i.test(t));
      let cur=new Date(`${startISO}T00:00:00`), exam=new Date(`${examISO}T00:00:00`), idx=0;
      while(cur<=exam){
        const dateStr=cur.toISOString().slice(0,10);
        let topic="Rest/Buffer Day";
        const dd = dayDiff(dateStr, examISO);
        if(dateStr===examISO){ topic="ASHRAE CHD Exam Day!"; }
        else if(dd>2){ topic=topicPool[idx%topicPool.length]; idx++; }
        else if(dd===2){ topic="Practice Exams & Final Review"; }
        else if(dd===1){ topic="Practice Exams & Final Review"; }
        schedule.push({ date:dateStr, topic, status: dateStr===examISO?'exam':'pending', notes:'', confidence:3 });
        cur.setDate(cur.getDate()+1);
      }
      return schedule;
    }

    function computeDashboard(){
      const today=todayISO();
      const daysRemaining = Math.max(0, dayDiff(today, EXAM_DATE));
      const daysCompleted = appState.schedule.filter(d=>d.status==='complete').length;
      const studyDays = appState.schedule.filter(d=>d.date!==EXAM_DATE).length;
      const progress = studyDays? Math.round((daysCompleted/studyDays)*100):0;
      el('days-remaining').textContent = String(daysRemaining);
      el('days-completed').textContent = String(daysCompleted);
      el('overall-progress').textContent = `${progress}%`;
    }

    /* ---------------- FIREBASE ---------------- */
    async function setupFirebase(){
      try{
        appState.app = initializeApp(firebaseConfig);
        appState.db = getFirestore(appState.app);
        appState.auth = getAuth(appState.app);
        await new Promise((resolve,reject)=>{
          const unsub=onAuthStateChanged(appState.auth, async (user)=>{
            try{
              if(!user){ await signInAnonymously(appState.auth); }
              appState.userId = appState.auth.currentUser?.uid || user?.uid || null;
              unsub(); resolve();
            }catch(e){ reject(e); }
          });
        });
        el('loading').classList.add('hidden');
        el('join-container').classList.remove('hidden');
      }catch(e){
        el('loading').textContent = `Auth failed: ${e.message}`;
      }
    }

    function listenPlan(planId){
      if(appState.unsub){ appState.unsub(); appState.unsub=null; }
      const ref = doc(appState.db, "plans", planId);
      appState.unsub = onSnapshot(ref, (snap)=>{
        if(snap.exists()){
          const raw = snap.data().schedule || [];
          appState.schedule = raw.map(d=>({ notes:'', confidence:3, ...d }));
        }else{
          appState.schedule = generateInitialSchedule();
          saveSchedule(); // create doc
        }
        render();
      }, (err)=>{
        surfaceError(`Realtime error: ${err.message}`);
      });
    }

    const saveSchedule = throttle(async function(){
      if(!appState.db || !appState.planId) return;
      try{
        const ref = doc(appState.db, "plans", appState.planId);
        await setDoc(ref, { schedule: appState.schedule, lastUpdated: serverTimestamp() }, { merge: true });
        // visual ping only when called explicitly; throttle prevents spam
      }catch(e){
        surfaceError(`Save failed: ${e.message}`);
      }
    }, 800);

    /* ---------------- AI HELPERS (via proxy) ---------------- */
    async function callAI(url, prompt){
      try{
        const res = await fetch(url, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ prompt }) });
        if(!res.ok) throw new Error(`HTTP ${res.status}`);
        return await res.json();
      }catch(e){
        throw new Error(`AI error: ${e.message}`);
      }
    }
    async function getAIInsight(topic){
      showInsight("Loading study insight ‚Ä¶");
      const prompt = `Explain concisely (<=150 words) the key concepts, formulas, and study tips for ASHRAE CHD topic "${topic}". Focus on ASHRAE 90.1 and 62.1. Use short bullets.`;
      try{
        const data = await callAI(API_URL_INSIGHT, prompt);
        const text = typeof data?.text === 'string' ? data.text : '';
        showInsight(text || "No insight returned.");
      }catch(e){ showInsight(e.message); }
    }
    async function getAIMCQs(topic){
      showInsight("Loading 5 MCQs ‚Ä¶");
      const prompt = `Generate 5 MCQs for "${topic}" relevant to ASHRAE CHD. Use ASHRAE standards. Strict JSON: [{"question":"...","options":["A","B","C","D"],"answer":"A"}]`;
      try{
        const data = await callAI(API_URL_MCQ, prompt);
        const raw = data?.json || data?.text || '';
        const json = parseMCQJson(raw);
        renderMCQs(json, topic);
      }catch(e){ showInsight(e.message); }
    }
    function parseMCQJson(s){
      // why: tolerate models that wrap JSON with prose; strict schema check
      const start = s.indexOf('['); const end = s.lastIndexOf(']');
      if(start===-1 || end===-1) throw new Error("Invalid MCQ JSON");
      const arr = JSON.parse(s.slice(start, end+1));
      return arr.filter(q=>q && typeof q.question==='string' && Array.isArray(q.options) && typeof q.answer==='string')
                .map(q=>({question:q.question, options:q.options.slice(0,6), answer:q.answer}));
    }

    /* ---------------- RENDERING ---------------- */
    function surfaceError(msg){
      const box = el('error-message'); box.textContent = msg; box.classList.remove('hidden'); toast(msg, 2000);
    }

    function filterSchedule(){
      const term = appState.currentSearch.toLowerCase().trim();
      return appState.schedule.filter(day=>{
        const matchesSearch = !term || day.topic.toLowerCase().includes(term) || (day.notes||'').toLowerCase().includes(term);
        if(!matchesSearch) return false;
        switch(appState.currentFilter){
          case 'complete': return day.status==='complete';
          case 'pending': return day.status!=='complete' && day.status!=='exam';
          case 'review': return day.confidence<3 && day.status!=='complete' && day.status!=='exam';
          default: return true;
        }
      });
    }

    function render(){
      computeDashboard();
      const grid = el('schedule-grid'); grid.innerHTML='';
      const today = todayISO();
      const filtered = filterSchedule();

      const frag=document.createDocumentFragment();
      for(const day of filtered){
        const idx = appState.schedule.findIndex(d=>d.date===day.date);
        const rag = clamp(Number(day.confidence||3),1,5);
        let cardClass='bg-gray-100 border-gray-300', textClass='text-gray-600', statusText='Planned', conf='';

        if(rag<=2){ cardClass='border-rag-1'; conf='‚ùó Low Conf.'; }
        else if(rag===3){ cardClass='border-rag-3'; conf='‚öôÔ∏è Average'; }
        else if(rag===4){ cardClass='border-rag-4'; conf='üëç Good'; }
        else { cardClass='border-rag-5'; conf='‚úÖ Mastered'; }

        if(day.status==='complete'){ cardClass='border-rag-5'; textClass='text-complete'; statusText='Completed!'; conf='‚úî Complete'; }
        else if(day.status==='in_progress'){ statusText='In Progress'; textClass=`text-rag-${rag}`; }
        else if(day.status==='pending'){ statusText='Pending'; textClass=`text-rag-${rag}`; }
        else if(day.status==='exam'){ cardClass='bg-primary-dark border-primary-dark text-white'; textClass='text-white'; statusText='EXAM DAY'; conf='GOOD LUCK!'; }

        const isToday = (day.date===today && day.status!=='exam');
        const noteBadge = (day.notes && day.notes.trim()!=='')? '<span class="ml-2 text-xs text-blue-600">üìù</span>':'';

        const wrapper=document.createElement('div');
        wrapper.setAttribute('role','listitem');
        wrapper.innerHTML = `
          <div class="day-card p-4 border-l-4 ${cardClass} text-gray-800 flex flex-col justify-between"
               data-index="${idx}" ${day.status!=='exam'?'data-edit="1"':''}>
            <div>
              <p class="text-xs font-semibold uppercase text-gray-500 mb-1">${formatDateISO(day.date)}</p>
              <p class="text-lg font-bold truncate ${day.status==='exam'?'text-white':''}">${sanitizeHtml(day.topic)}${noteBadge}</p>
            </div>
            <div class="mt-2 pt-2 border-t border-gray-200 flex justify-between items-center">
              <span class="text-sm font-medium ${textClass}">${isToday?(day.status==='complete'?'COMPLETED TODAY':'CURRENT FOCUS'):statusText}</span>
              <span class="text-xs font-semibold ${day.status==='exam'?'text-white':textClass}">${conf}</span>
            </div>
          </div>`;
        if(isToday && day.status!=='exam'){
          wrapper.firstElementChild.classList.add('border-4','border-dashed','border-current');
        }
        frag.appendChild(wrapper.firstElementChild);
      }
      grid.appendChild(frag);
    }

    function showInsight(content, sources=[]){
      const panel = el('insight-panel'); const contentDiv=el('insight-content'); const src=el('insight-sources');
      panel.classList.remove('hidden');
      if(!content || /loading/i.test(content)){
        contentDiv.innerHTML = `<span class="text-gray-500">${sanitizeHtml(content||'Loading...')}</span>`;
        src.classList.add('hidden'); return;
      }
      contentDiv.innerHTML = sanitizeHtml(content);
      if(Array.isArray(sources) && sources.length){
        src.classList.remove('hidden');
        src.innerHTML = sources.map(s=>`<a class="underline" href="${s.uri}" target="_blank" rel="noopener">${sanitizeHtml(s.title||s.uri)}</a>`).join(' | ');
      }else{ src.classList.add('hidden'); }
    }

    function renderMCQs(questions, topic){
      const contentDiv=el('insight-content');
      const blocks = questions.map((q,i)=>{
        const opts = q.options.map(o=>`<li class="p-2 border border-gray-200 rounded-md mb-1 bg-gray-50">${sanitizeHtml(o)}</li>`).join('');
        return `
          <div class="mb-4 p-4 border border-blue-200 bg-blue-50 rounded-lg shadow-sm">
            <p class="font-semibold text-primary-dark">Q${i+1}: ${sanitizeHtml(q.question)}</p>
            <ul class="space-y-1 text-gray-800">${opts}</ul>
            <button class="show-answer button-main mt-2 px-3 py-1 text-xs" data-answer="${sanitizeHtml(q.answer)}">Show Answer</button>
            <p class="answer mt-2 p-2 bg-white border border-blue-300 rounded hidden italic text-sm font-semibold text-green-700"></p>
          </div>`;
      }).join('');
      contentDiv.innerHTML = `<h4 class="text-lg font-bold text-gray-800 mb-2">Practice MCQs: ${sanitizeHtml(topic)}</h4>${blocks}`;
    }

    /* --------------- MODAL --------------- */
    function openModal(index){
      appState.editingIndex = index;
      const day = appState.schedule[index]; if(!day || day.status==='exam') return;

      el('modal-date-display').textContent = formatDateISO(day.date);
      const topicInput = el('modal-topic-input');
      const datalist = el('topic-options'); datalist.innerHTML='';
      CORE_TOPICS.forEach(t=>{ const o=document.createElement('option'); o.value=t; datalist.appendChild(o); });
      topicInput.value = day.topic;
      el('modal-status').value = day.status;
      el('modal-notes').value = day.notes || '';
      const slider = el('modal-confidence'); slider.value = String(day.confidence||3); updateConfidenceDisplay(slider.value);
      slider.oninput = (e)=>updateConfidenceDisplay(e.target.value);

      el('edit-modal').classList.remove('hidden'); document.body.classList.add('modal-open');
      setTimeout(()=> topicInput.focus(), 0);
    }
    function closeModal(){
      el('edit-modal').classList.add('hidden'); document.body.classList.remove('modal-open'); appState.editingIndex=-1;
    }
    function updateConfidenceDisplay(value){
      const v=Number(value); const display=el('confidence-value'); const label=el('confidence-label');
      let text='', cls='rag-3';
      if(v<=2){ text='(Needs Review)'; cls='rag-1'; }
      else if(v===3){ text='(Average)'; cls='rag-3'; }
      else if(v===4){ text='(Good)'; cls='rag-4'; }
      else { text='(Mastered)'; cls='rag-5'; }
      display.textContent=String(v); display.className=`font-bold ${cls}`;
      label.textContent=text; label.className=`text-xs ml-2 ${cls}`;
    }

    /* --------------- EVENTS --------------- */
    // Delegated click for cards
    el('schedule-grid').addEventListener('click',(e)=>{
      const card = e.target.closest('[data-edit="1"]'); if(!card) return;
      const index = Number(card.dataset.index); openModal(index);
    });

    el('close-modal').addEventListener('click', closeModal);
    document.addEventListener('keydown',(e)=>{ if(e.key==='Escape'){ closeModal(); }});

    el('save-modal').addEventListener('click', async ()=>{
      const i = appState.editingIndex; if(i<0) return;
      const topic = el('modal-topic-input').value.trim().slice(0,200);
      const status = el('modal-status').value;
      const notes = el('modal-notes').value.slice(0,2000);
      const confidence = clamp(parseInt(el('modal-confidence').value,10)||3,1,5);

      Object.assign(appState.schedule[i], { topic, status, notes, confidence });
      closeModal(); render();
      await saveSchedule(); toast('Saved');
    });

    // Filters
    document.querySelectorAll('#filter-controls .filter-btn').forEach(btn=>{
      btn.addEventListener('click', (e)=>{
        document.querySelectorAll('#filter-controls .filter-btn').forEach(b=>b.classList.remove('bg-primary-dark','text-white','shadow-lg'));
        e.currentTarget.classList.add('bg-primary-dark','text-white','shadow-lg');
        appState.currentFilter = e.currentTarget.dataset.filter;
        render();
      });
    });

    // Search (debounced)
    el('search-input').addEventListener('input', debounce((e)=>{
      appState.currentSearch = e.target.value; render();
    }, 200));

    // Join/Create/Copy
    el('join-plan-btn').addEventListener('click', joinPlan);
    el('create-plan-btn').addEventListener('click', createPlan);
    el('copy-plan-id-btn').addEventListener('click', async ()=>{
      try{
        await navigator.clipboard.writeText(el('plan-id-code').textContent);
        toast('Plan ID copied');
      }catch{ toast('Copy failed'); }
    });

    // AI buttons
    el('get-insight-modal').addEventListener('click', ()=>{ const t=el('modal-topic-input').value.trim(); if(t) getAIInsight(t); });
    el('get-questions-modal').addEventListener('click', ()=>{ const t=el('modal-topic-input').value.trim(); if(t) getAIMCQs(t); });

    /* --------------- PLAN FLOW --------------- */
    async function createPlan(){
      const rnd = Math.random().toString(36).slice(2,8);
      const planId = `chd-study-${rnd}`;
      appState.planId = planId;
      appState.schedule = generateInitialSchedule();
      await saveSchedule();
      loadPlanUI(planId);
      toast('New plan created');
      history.replaceState(null, '', `?plan=${encodeURIComponent(planId)}`);
    }
    async function joinPlan(){
      const planId = el('plan-id-input').value.trim();
      const err = el('join-error');
      if(!validatePlanId(planId)){ err.textContent='Invalid Plan ID format.'; err.classList.remove('hidden'); return; }
      try{
        const ref = doc(appState.db, "plans", planId);
        const snap = await getDoc(ref);
        if(snap.exists()){
          err.classList.add('hidden'); loadPlanUI(planId);
          history.replaceState(null, '', `?plan=${encodeURIComponent(planId)}`);
        }else{
          err.textContent='Plan ID not found.'; err.classList.remove('hidden');
        }
      }catch(e){
        err.textContent=`Error: ${e.message}`; err.classList.remove('hidden');
      }
    }

    function loadPlanUI(planId){
      appState.planId = planId;
      el('join-container').classList.add('hidden');
      el('app-container').classList.remove('hidden');
      el('plan-id-code').textContent = planId;
      el('plan-id-display').classList.remove('hidden');
      listenPlan(planId);
      // activate "All"
      const allBtn = document.querySelector('#filter-controls [data-filter="all"]');
      document.querySelectorAll('#filter-controls .filter-btn').forEach(b=>b.classList.remove('bg-primary-dark','text-white','shadow-lg'));
      allBtn.classList.add('bg-primary-dark','text-white','shadow-lg');
    }

    function bootFromQuery(){
      const p = new URLSearchParams(location.search).get('plan');
      if(p && validatePlanId(p)){
        el('loading').classList.add('hidden');
        el('join-container').classList.add('hidden');
        loadPlanUI(p);
      }else{
        el('join-container').classList.remove('hidden');
      }
    }

    /* --------------- STARTUP --------------- */
    window.addEventListener('load', async ()=>{
      // show join while auth spins
      el('join-container').classList.remove('hidden');
      await setupFirebase();
      bootFromQuery();
    });
  </script>
</body>
</html>
