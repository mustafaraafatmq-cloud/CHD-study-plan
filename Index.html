<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CHD Collaborative Study Planner</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300..800&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; }
        .day-card { transition: all 0.2s ease; cursor: pointer; }
        .day-card:hover { transform: translateY(-3px); box-shadow: 0 8px 20px rgba(0,0,0,0.15); }
        .modal-bg { background-color: rgba(0, 0, 0, 0.6); }
        .bg-status-complete { background-color: #dcfce7; border-color: #16a34a; }
        .bg-status-pending { background-color: #fef9c3; border-color: #f59e0b; }
        .bg-status-progress { background-color: #dbeafe; border-color: #2563eb; }
        .bg-status-exam { background-color: #1e3a8a; color: white; border-color: #1e40af; }
    </style>
</head>

<body class="bg-gray-100 min-h-screen p-5">

<div class="max-w-6xl mx-auto">
    <!-- Header -->
    <header class="text-center mb-8">
        <h1 class="text-4xl font-bold text-blue-800">ASHRAE CHD Collaborative Study Planner</h1>
        <p class="text-gray-600 mt-2">Plan + Track + Study with Friends â€” up to exam date: <strong>Nov. 24</strong></p>
    </header>

    <!-- Auth + Join/Create -->
    <section id="auth-section" class="max-w-md mx-auto bg-white p-6 rounded-lg shadow-lg mb-10">
        <h2 class="text-xl font-semibold mb-4 text-gray-700 text-center">Join or Create Plan</h2>
        
        <div class="mb-4">
            <input id="join-id" type="text" placeholder="Enter Plan ID to Join" 
                class="w-full border p-3 rounded-md text-sm" maxlength="15">
        </div>
        
        <button id="join-plan-btn" class="w-full py-2 bg-blue-600 text-white rounded-md mb-4">Join Plan</button>
        
        <p class="text-center text-gray-500 mb-3">OR</p>
        
        <button id="create-plan-btn" class="w-full py-2 bg-green-600 text-white rounded-md">Create New Plan</button>
        
        <p id="auth-error" class="text-center text-red-500 mt-4 hidden"></p>
    </section>

    <!-- Main App Container -->
    <section id="app-section" class="hidden">
        <div class="flex justify-between items-center mb-5">
            <div>
                <h2 class="text-2xl font-bold text-gray-800">Your Study Plan</h2>
                <p id="plan-id-display" class="text-sm text-gray-500"></p>
            </div>
            <button id="leave-plan-btn" class="px-4 py-2 bg-red-600 text-white rounded-md">Leave Plan</button>
        </div>

        <!-- Progress Summary -->
        <div id="progress-summary" class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-6">
            <div class="p-4 bg-blue-100 rounded-lg text-center">
                <p class="text-sm text-gray-600">Days Remaining</p>
                <p id="days-remaining" class="text-2xl font-bold text-blue-700">--</p>
            </div>
            <div class="p-4 bg-green-100 rounded-lg text-center">
                <p class="text-sm text-gray-600">Days Completed</p>
                <p id="days-completed" class="text-2xl font-bold text-green-700">--</p>
            </div>
            <div class="p-4 bg-yellow-100 rounded-lg text-center">
                <p class="text-sm text-gray-600">Overall Progress</p>
                <p id="progress-percent" class="text-2xl font-bold text-yellow-600">--%</p>
            </div>
        </div>

        <!-- Study Grid -->
        <div id="study-grid" class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-5 gap-4"></div>
    </section>
</div>

<!-- Modal -->
<div id="edit-modal" class="modal-bg fixed inset-0 hidden items-center justify-center p-4 z-50">
    <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-md">
        <h3 class="text-lg font-semibold mb-3">Edit Study Day: <span id="modal-date" class="text-blue-700"></span></h3>
        <div class="mb-3">
            <label class="block text-sm text-gray-600 mb-1">Topic:</label>
            <input type="text" id="modal-topic" class="w-full border rounded p-2 text-sm">
        </div>
        <div class="mb-3">
            <label class="block text-sm text-gray-600 mb-1">Status:</label>
            <select id="modal-status" class="w-full border rounded p-2 text-sm">
                <option value="pending">Pending</option>
                <option value="in_progress">In Progress</option>
                <option value="complete">Complete</option>
            </select>
        </div>
        <div class="mb-3">
            <label class="block text-sm text-gray-600 mb-1">Notes:</label>
            <textarea id="modal-notes" class="w-full border rounded p-2 text-sm" rows="2"></textarea>
        </div>
        <div class="flex justify-end space-x-2 mt-4">
            <button id="close-modal-btn" class="px-4 py-2 bg-gray-300 rounded">Cancel</button>
            <button id="save-modal-btn" class="px-4 py-2 bg-blue-600 text-white rounded">Save</button>
        </div>
    </div>
</div>

<!-- Firebase & Planner Logic -->
<script type="module">
/* Firebase Imports */
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
import { getFirestore, doc, setDoc, getDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

/* Firebase Config */
const firebaseConfig = {
  apiKey: "AIzaSyAWi2fE6rxQO2YwH3bayf7zB9NsEoPGXYM",
  authDomain: "chd-study-plan.firebaseapp.com",
  projectId: "chd-study-plan",
  storageBucket: "chd-study-plan.firebasestorage.app",
  messagingSenderId: "329855623463",
  appId: "1:329855623463:web:32be2774d68574ca910902"
};

/* Global Vars */
let app, db, auth, userId, currentPlanId, scheduleData = [];
const EXAM_DATE = "2025-11-24";

/* Initialize Firebase */
async function initFirebase() {
    app = initializeApp(firebaseConfig);
    db = getFirestore(app);
    auth = getAuth(app);
    await signInAnonymously(auth);
}

/* Auth Listener */
onAuthStateChanged(getAuth(), (user) => {
    if (user) {
        userId = user.uid;
        console.log("Authenticated as:", userId);
    }
});

/* UI Elements */
const authSection = document.getElementById('auth-section');
const appSection = document.getElementById('app-section');
const joinBtn = document.getElementById('join-plan-btn');
const createBtn = document.getElementById('create-plan-btn');
const leaveBtn = document.getElementById('leave-plan-btn');

/* Helper: Generate a clean schedule */
function generateSchedule() {
    let date = new Date("2025-11-01");
    const end = new Date(EXAM_DATE);
    const topics = [
        'HVAC Fundamentals', 'Psychrometric Charts', 'Load Calculations',
        'Hydronics and Pumps', 'Control Systems', 'ASHRAE 62.1/90.1',
        'VAV / VRF / DX Systems', 'Duct Design', 'Energy Analysis', 'Review Day'
    ];
    let idx = 0, schedule = [];
    while (date <= end) {
        schedule.push({
            date: date.toISOString().slice(0,10),
            topic: date.toISOString().slice(0,10) === EXAM_DATE ? "CHD EXAM DAY" : topics[idx % topics.length],
            status: "pending",
            notes: ""
        });
        idx++;
        date.setDate(date.getDate() + 1);
    }
    return schedule;
}

/* Create New Plan */
createBtn.onclick = async () => {
    currentPlanId = "chd-" + Math.random().toString(36).substring(2, 8);
    scheduleData = generateSchedule();
    await setDoc(doc(db, "plans", currentPlanId), { schedule: scheduleData });
    loadPlan(currentPlanId);
};

/* Join Plan */
joinBtn.onclick = async () => {
    let id = document.getElementById('join-id').value.trim();
    if (!id) return alert("Enter a plan ID");
    const snap = await getDoc(doc(db, "plans", id));
    if (snap.exists()) {
        currentPlanId = id;
        loadPlan(id);
    } else alert("Plan not found");
};

/* Load Plan */
function loadPlan(planId) {
    authSection.classList.add('hidden');
    appSection.classList.remove('hidden');
    document.getElementById('plan-id-display').textContent = `Plan ID: ${planId} (share with friend)`;

    const planRef = doc(db, "plans", planId);
    onSnapshot(planRef, (snap) => {
        scheduleData = snap.data().schedule;
        renderGrid();
        updateProgress();
    });
}

/* Render Grid */
const grid = document.getElementById('study-grid');
function renderGrid() {
    grid.innerHTML = "";
    scheduleData.forEach((day, i) => {
        let statusColor = day.status === "complete" ? "bg-status-complete" :
                          day.status === "in_progress" ? "bg-status-progress" :
                          day.status === "exam" ? "bg-status-exam" : "bg-status-pending";

        const card = `<div onclick="openModal(${i})" class="day-card border-l-4 p-3 rounded ${statusColor}">
            <p class="text-sm text-gray-500">${new Date(day.date).toDateString().slice(0,10)}</p>
            <p class="font-semibold">${day.topic}</p>
            <p class="text-xs mt-2">${day.status}</p>
        </div>`;
        grid.innerHTML += card;
    });
}

/* Modal Logic */
window.openModal = function(i) {
    const day = scheduleData[i];
    window.editIndex = i;
    document.getElementById('modal-date').textContent = day.date;
    document.getElementById('modal-topic').value = day.topic;
    document.getElementById('modal-status').value = day.status;
    document.getElementById('modal-notes').value = day.notes;
    document.getElementById('edit-modal').classList.remove('hidden');
};

document.getElementById('close-modal-btn').onclick = () => {
    document.getElementById('edit-modal').classList.add('hidden');
};

document.getElementById('save-modal-btn').onclick = async () => {
    const idx = window.editIndex;
    scheduleData[idx].topic = document.getElementById('modal-topic').value;
    scheduleData[idx].status = document.getElementById('modal-status').value;
    scheduleData[idx].notes = document.getElementById('modal-notes').value;
    await setDoc(doc(db,"plans",currentPlanId), { schedule: scheduleData });
    document.getElementById('edit-modal').classList.add('hidden');
};

/* Leave Plan */
leaveBtn.onclick = () => {
    currentPlanId = null;
    authSection.classList.remove('hidden');
    appSection.classList.add('hidden');
};

/* Update Progress Summary */
function updateProgress() {
    const done = scheduleData.filter(d => d.status === "complete").length;
    const total = scheduleData.length;
    document.getElementById('days-completed').textContent = done;
    document.getElementById('progress-percent').textContent = Math.round(done / total * 100) + "%";
    const today = new Date().toISOString().slice(0,10);
    const rem = scheduleData.filter(d => d.date >= today).length;
    document.getElementById('days-remaining').textContent = rem;
}

/* Start App */
initFirebase();
</script>

</body>
</html>
